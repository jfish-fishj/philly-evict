# Gender Imputation Pipeline

## Overview

Imputes binary gender probabilities (male/female) for eviction defendants using first names and the SSA baby name database.

Primary script:
- `r/impute-gender.R`

Upstream dependency:
- `r/impute-race-preflight.R` (provides the parsed person-level input file)

Primary outputs (in `output/qa/`):
- `gender_imputed_person_sample.csv` — person-level probabilities
- `gender_imputed_case_sample.csv` — case-level aggregates
- `gender_imputed_qa_sample.txt` — QA summary report

## Method

The script uses the `gender` R package (`gender::gender()`) with the SSA (Social Security Administration) baby name method. SSA records cover birth years 1932--2012, providing historical name-gender frequency distributions.

For each unique first name among analysis defendants:
1. Look up the name in the SSA database
2. Return `p_male` and `p_female` (proportions of babies with that name who were male/female)
3. Normalize so `p_male + p_female = 1`

No geography is needed -- gender imputation is name-only.

### Backends

- **Primary**: `gender` R package + `genderdata` (SSA data). Install `genderdata` via `remotes::install_github("lmullen/genderdata")`.
- **Fallback**: Optional CSV lookup table via `--lookup=path.csv` (must have columns `name` + `p_female` or `p_male`).

## Target Population

The script filters to the same analysis population as race imputation:

- `is_analysis_defendant == TRUE` — defendants only (excludes plaintiffs)
- `impute_status == "ok"` — excludes entities flagged as non-persons, missing names, missing geography, and counterclaim-linked parties
- Must have a non-missing `first_name`

Rows not meeting these criteria receive a descriptive `gender_impute_status` (e.g., `not_defendant`, `not_person`, `counterclaim_party`, `missing_first_name`).

## Person-Level Output

| Column | Description |
|--------|-------------|
| `p_male` | Probability the person is male (from SSA name frequencies) |
| `p_female` | Probability the person is female |
| `gender_hat` | Point estimate: `"female"` if `p_female >= p_male`, else `"male"` |
| `gender_hat_p` | Confidence: `max(p_female, p_male)` |
| `is_gender_confident` | `TRUE` if `gender_hat_p >= confidence_threshold` (default 0.7) |
| `gender_impute_status` | `"ok"`, `"name_not_found"`, `"not_person"`, `"not_defendant"`, etc. |

## Case-Level Output

For each case (`id`), aggregates across all imputed defendants:

| Column | Description |
|--------|-------------|
| `n_defendants_total` | Number of analysis defendants on the case |
| `n_defendants_gender_imputed` | Number with `gender_impute_status == "ok"` |
| `case_p_female` | Mean `p_female` across imputed defendants |
| `case_p_male` | Mean `p_male` across imputed defendants |
| `case_any_female` | `1 - prod(1 - p_female)` — probability at least one defendant is female |
| `case_any_male` | `1 - prod(1 - p_male)` — probability at least one defendant is male |
| `case_gender_impute_status` | `"ok"` if any defendant was imputed, else `"no_imputed_defendants"` |

## Running

```bash
# Full run (all defendants)
Rscript r/impute-gender.R --sample-n=NA

# Sample run (default 5,000 rows, for testing)
Rscript r/impute-gender.R

# Custom options
Rscript r/impute-gender.R --sample-n=NA --confidence-threshold=0.8 --seed=42
```

Requires the preflight output to exist at `output/qa/race_imputation_preflight_person.csv` (generated by `r/impute-race-preflight.R`).

## Coverage (Full Run, Feb 2026)

| Status | Count | Share of Analysis Defendants |
|--------|------:|---:|
| ok (imputed) | 453,113 | 88.7% |
| name_not_found | 46,032 | 9.0% |
| not_person | 8,760 | 1.7% |
| no_tract | 1,903 | 0.4% |
| missing_first_name | 1,108 | 0.2% |

Gender distribution among imputed defendants:
- Female: 61.2%
- Male: 38.8%
- Confident (p >= 0.7): 98.7%

Case-level: 91.3% of cases (368K / 403K) have at least one gender-imputed defendant.

## Limitations

- **Binary classification**: Only male/female. Non-binary and gender-nonconforming individuals are not captured.
- **Name-only**: No geographic or demographic covariates. Gender-name associations vary by cohort, ethnicity, and culture.
- **SSA coverage**: Names not in the 1932--2012 SSA database (9% of defendants) receive no imputation. These are disproportionately non-English names.
- **Historical bias**: SSA data reflects naming patterns of US-born individuals. Immigrants and non-citizens may have different name-gender distributions.
